FROM php:7-fpm

LABEL Description="This image provides PHP-fpm with common extensions"
MAINTAINER Grgiori Kochanov public@grik.net

RUN apt-get update && apt-get install -y --no-install-recommends \
        libfreetype6-dev  libjpeg62-turbo-dev  libpng12-dev libmagickcore-dev libmagickwand-dev \
        libmemcached-dev libxslt1-dev  imagemagick-6 \
    && rm -rf /var/lib/apt/lists/* \
    && docker-php-ext-configure gd --with-freetype-dir=/usr/include/ --with-jpeg-dir=/usr/include/ \
    && docker-php-ext-install -j$(nproc) iconv  \
    && docker-php-ext-install -j$(nproc) gd \
    && docker-php-ext-install -j$(nproc) mbstring \
    && docker-php-ext-install -j$(nproc) bcmath \
    && docker-php-ext-install -j$(nproc) mysqli \
    && docker-php-ext-install -j$(nproc) xsl \
    && docker-php-ext-install -j$(nproc) iconv \
    && apt-get purge -y --auto-remove -o APT::AutoRemove::RecommendsImportant=false -o APT::AutoRemove::SuggestsImportant=false \
        libfreetype6-dev  libjpeg62-turbo-dev  libpng12-dev libmagickcore-dev libmagickwand-dev libmemcached-dev libxslt1-dev

# Installing XDebug from sources
ENV XDEBUG_FILENAME xdebug-2.4.0rc4.tgz

RUN curl -fSL "https://xdebug.org/files/$XDEBUG_FILENAME" -o "$XDEBUG_FILENAME" \
    && mkdir -p /usr/src/xdebug \
    && tar -xf "$XDEBUG_FILENAME" --strip-components=1 -C /usr/src/xdebug \
    && rm "$XDEBUG_FILENAME" \
    && cd /usr/src/xdebug \
    && phpize && ./configure && make && make install \
    && rm -rf /usr/src/xdebug


# Installing Memcached from sources
RUN  cd /usr/src/ && git clone https://github.com/php-memcached-dev/php-memcached.git \
    && cd php-memcached \
    && git checkout php7 \
    && phpize \
    && ./configure --disable-memcached-sasl \
    && make && make install \
    && cd .. && rm -rf php-memcached \
    && docker-php-ext-enable memcached \

# Generate an extended CLI version

RUN cd /usr/src/php \
    && ./configure \
    --with-config-file-path="$PHP_INI_DIR" \
    --with-config-file-scan-dir="$PHP_INI_DIR/conf.d" \
    --with-fpm-user=www-data --with-fpm-group=www-data \
    --disable-cgi --enable-ftp --with-zlib --enable-mysqlnd --with-readline --with-openssl --with-curl \
    --enable-sockets --enable-sysvsem --enable-sysvshm --enable-shmop --enable-posix --without-pear --enable-pcntl
    && make -j"$(nproc)" && make install && make clean

